{% extends 'base.html' %}
{% block content %}

  <div style="display: flex; flex-direction: column; align-items: center; width: 100%;">
    <br>
    <img id="tree" src="../static/Images/WiseMysticalTreeClose.jpg">
    <br>
    <a href=''>Try Again</a>
    <div id="questions"style="border: 2px solid black; display: flex; flex-direction: column; align-items: center; width:60%;">
      <p id="question">The most mystical and wise tree will choose the food for you</p>
      <button id="start" value="">Start</button>
      <button id="yes" value="" style="display:none;">Yes</button>
      <button id="no" value="" style="display:none;">No</button>
      <button id="showmeal" value="" style="display:none;">Show</button>
    </div>
    <div id="meals"style="display: flex; flex-direction: row; justify-content: space-evenly;width:100%;flex-wrap: wrap; margin-top:1%; width:80%;">
    </div>
    <audio id="audio" src="../static/Sound/oof.mp3"></audio>
  </div>

  <script>
    var categorygroups = [];
    var preferences = [];
    var notimes = 0;
    var number = 0;
    var preference = false;

    function setTalkingTree() {
        var question = $("#question").html().split(" ");
        for (let i = 0; i <question.length*2; i++) {
          let interbal = Math.floor((Math.random() * 1500) + 1000);
          setTimeout(
            function () {
              var audio = document.getElementById("audio");
              audio.play();
              if($("#tree").attr('src') == "../static/Images/WiseMysticalTreeClose.jpg"){
                $("#tree").attr('src',"../static/Images/WiseMysticalTreeOpen.jpg") ;
              }else{
                $("#tree").attr('src', "../static/Images/WiseMysticalTreeClose.jpg");
              }
            }, interbal);
        }
        $("#question").attr('src', "../static/Images/WiseMysticalTreeClose.jpg");
    }

    $(document).ready(function () {
      setTalkingTree();

      $("#start").click(function () {
        $("#yes").show();
        $("#no").show();
        $("#start").hide();
        let json = {
          categorygroups: JSON.stringify(categorygroups),
          preferences: JSON.stringify(preferences),
          number: JSON.stringify(number)
        };
        let csrftoken = "{{csrf_token}}";
        $.ajax({
          type: 'POST',
          headers: { 'X-CSRFToken': csrftoken },
          url: "{% url 'filterquestion' %}",
          data: json,
          dataType: 'json',
          success: function (data) {
            let lerroa = data[0];
            $("#yes").val(data[1]);
            $('#question').html(lerroa);
            setTalkingTree();
          }, error: function (e) {
            alert(e);
          }
        })
      });

      $("#yes").click(function () {
        categorygroups.push($("#yes").val());
        if (preference) {
          preferences.push($("#yes").val());
        }
        number = notimes;
        let json = {
          categorygroups: JSON.stringify(categorygroups),
          number: JSON.stringify(number)
        };
        let csrftoken = "{{csrf_token}}";
        $.ajax({
          type: 'POST',
          headers: { 'X-CSRFToken': csrftoken },
          url: "{% url 'filterquestion' %}",
          data: json,
          dataType: 'json',
          success: function (data) {
            if (data[0] != "") {
              $("#yes").val(data[1]);
              $('#question').html(data[0]);
              preference = data[2];
            } else {
              $('#question').html("The MysticalWiseTree thinks that the perfect meal for your need is");
              $("#yes").hide();
              $("#no").hide();
              $("#showmeal").show();
            }
            setTalkingTree();
          }, error: function (e) {
            alert(e);
          }
        })
      });

      $("#no").click(function () {
        notimes++;
        number += 1;
        let json = {
          categorygroups: JSON.stringify(categorygroups),
          number: JSON.stringify(number)
        };
        let csrftoken = "{{csrf_token}}";
        $.ajax({
          type: 'POST',
          headers: { 'X-CSRFToken': csrftoken },
          url: "{% url 'filterquestion' %}",
          data: json,
          dataType: 'json',
          success: function (data) {
            if (data[0] != "") {
              $("#yes").val(data[1]);
              $('#question').html(data[0]);
              preference = data[2];
            } else {
              $('#question').html("The MysticalWiseTree thinks that the perfect meal for your need is");
              $("#yes").hide();
              $("#no").hide();
              $("#showmeal").show();
            }
            setTalkingTree();
          }, error: function (e) {
            alert(e);
          }
        })
      });

      $("#showmeal").click(function () {
        let json = {
          categorygroups: JSON.stringify(categorygroups),
          preferences: JSON.stringify(preferences),
        };
        let csrftoken = "{{csrf_token}}";
        $.ajax({
          type: 'POST',
          headers: { 'X-CSRFToken': csrftoken },
          url: "{% url 'filtermeal' %}",
          data: json,
          dataType: 'json',
          success: function (data) {
            let lerroa ="";
            
            for (let i = 0; i < data.length; i++) {
              lerroa += "<div style='border: 2px solid black;border-radius:25px; width:20%;margin-top:1%; display:flex; flex-direction:column; align-items:center;'>"
              lerroa += "<p style='font-size:90%;'>"+data[i][0][0]+"</p>";
              lerroa += "<img style='width:80%;' src='"+data[i][0][2]+"'>";
              lerroa += "<div style='display:flex; flex-direction:row;'>"
              for (let k = 1; k < data[i].length; k++) {
                lerroa += "<img style='width:100%;' src='" + data[i][k][1] + "'>";
              }
              lerroa += "</div>"
              lerroa += "<div style='width:70%; text-align: center;'>"
              lerroa += "<p style='font-size:100%;'>"+data[i][0][1]+"</p>";
              lerroa += "<p style='font-size:100%;'>"+data[i][0][3]+"â‚¬</p>";
              lerroa += "</div>"
              lerroa += "<a style='font-size:90%;' href='addmeal/"+data[i][0][5]+"'target='_blank' > ADD TO CART </a>";
              lerroa += "</div>"
            }
            $('#meals').html(lerroa)
            $("#showmeal").hide()
          }, error: function (e) {
            alert(e);
          }
        })
      });
    });
  </script>
{% endblock content %}